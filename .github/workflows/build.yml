name: Build Flutter Apps (No Local Flutter Required)

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³

jobs:
  # Androidãƒ“ãƒ«ãƒ‰
  build-android:
    name: ğŸ“± Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: ğŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true
    
    - name: ğŸ—ï¸ Create project structure (ios/android folders)
      run: |
        echo "ğŸ“¦ Creating Flutter project structure..."
        flutter create --org com.mathstudy temp_project
        
        echo "ğŸ“ Copying android folder..."
        cp -r temp_project/android ./
        
        echo "ğŸ§ª Copying test folder..."
        mkdir -p test
        cp -r temp_project/test/* ./test/ || true
        
        echo "ğŸ§¹ Cleanup..."
        rm -rf temp_project
        
        echo "âœ… Project structure ready!"
        ls -la
    
    - name: ğŸ“¦ Get dependencies
      run: flutter pub get
    
    - name: ğŸ”¨ Build APK
      run: flutter build apk --release
    
    - name: ğŸ“¤ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: math-study-app-android.apk
        path: build/app/outputs/flutter-apk/app-release.apk
        retention-days: 30

  # iOSãƒ“ãƒ«ãƒ‰
  build-ios:
    name: ğŸ Build iOS App
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true
    
    - name: ğŸ—ï¸ Create project structure (ios/android folders)
      run: |
        echo "ğŸ“¦ Creating Flutter project structure..."
        flutter create --org com.mathstudy temp_project
        
        echo "ğŸ“ Copying ios folder..."
        cp -r temp_project/ios ./
        
        echo "ğŸ“ Copying macos folder..."
        cp -r temp_project/macos ./
        
        echo "ğŸ§ª Copying test folder..."
        mkdir -p test
        cp -r temp_project/test/* ./test/ || true
        
        echo "ğŸ§¹ Cleanup..."
        rm -rf temp_project
        
        echo "âœ… Project structure ready!"
        ls -la
    
    - name: ğŸ“¦ Get dependencies
      run: flutter pub get
    
    - name: ğŸ”¨ Build iOS (no codesign)
      run: flutter build ios --release --no-codesign
    
    - name: ğŸ“¦ Create IPA
      run: |
        cd build/ios/iphoneos
        mkdir Payload
        cp -r Runner.app Payload/
        zip -r ../../../math-study-app.ipa Payload
    
    - name: ğŸ“¤ Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: math-study-app-ios.ipa
        path: math-study-app.ipa
        retention-days: 30
